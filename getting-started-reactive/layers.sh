#!/usr/bin/env bash

set -ex

# Base layer:
native-image \
  -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager \
  -J-Dsun.nio.ch.maxUpdateArraySize=100 \
  -J-Dlogging.initial-configurator.min-level=500 \
  -J-Duser.language=en \
  -J-Duser.country=GB \
  -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory \
  -J-Dvertx.disableDnsResolver=true \
  -J-Dio.netty.leakDetection.level=DISABLED \
  -J-Dio.netty.allocator.maxOrder=3 \
  -H:+UnlockExperimentalVMOptions \
  -H:IncludeLocales=en-GB \
  -H:-UnlockExperimentalVMOptions \
  -J-Dfile.encoding=UTF-8 \
  -J--add-exports=org.graalvm.nativeimage.builder/com.oracle.svm.core.jdk=ALL-UNNAMED \
  --features=io.quarkus.runner.Feature,io.quarkus.runtime.graal.DisableLoggingFeature,io.quarkus.runtime.graal.JVMChecksFeature,io.quarkus.runtime.graal.SkipConsoleServiceProvidersFeature \
  -J--add-exports=java.security.jgss/sun.security.krb5=ALL-UNNAMED \
  -J--add-exports=java.security.jgss/sun.security.jgss=ALL-UNNAMED \
  -J--add-opens=java.base/java.text=ALL-UNNAMED \
  -J--add-opens=java.base/java.io=ALL-UNNAMED \
  -J--add-opens=java.base/java.lang.invoke=ALL-UNNAMED \
  -J--add-opens=java.base/java.util=ALL-UNNAMED \
  -H:+UnlockExperimentalVMOptions \
  -H:BuildOutputJSONFile=getting-started-reactive-1.0.0-SNAPSHOT-runner-build-output-stats.json \
  -H:-UnlockExperimentalVMOptions \
  -H:+UnlockExperimentalVMOptions \
  -H:+GenerateBuildArtifactsFile \
  -H:-UnlockExperimentalVMOptions \
  -H:+UnlockExperimentalVMOptions \
  -H:+AllowFoldMethods \
  -H:-UnlockExperimentalVMOptions \
  -J-Djava.awt.headless=true \
  --no-fallback \
  --link-at-build-time \
  -H:+UnlockExperimentalVMOptions \
  -H:+ReportExceptionStackTraces \
  -H:-UnlockExperimentalVMOptions \
  -H:-AddAllCharsets \
  --enable-url-protocols=http \
  --enable-monitoring=heapdump \
  -H:+UnlockExperimentalVMOptions \
  -H:-UseServiceLoaderFeature \
  -H:-UnlockExperimentalVMOptions \
  -J--add-exports=org.graalvm.nativeimage/org.graalvm.nativeimage.impl=ALL-UNNAMED \
  --exclude-config io\.netty\.netty-codec /META-INF/native-image/io\.netty/netty-codec/generated/handlers/reflect-config\.json \
  --exclude-config io\.netty\.netty-handler /META-INF/native-image/io\.netty/netty-handler/generated/handlers/reflect-config\.json \
  getting-started-reactive-1.0.0-SNAPSHOT-runner \
  -jar getting-started-reactive-1.0.0-SNAPSHOT-runner.jar

# Micronaut base layer:
# native-image \
#   -cp /home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/micronaut-hello-rest-maven-layered-0.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-server-netty/4.10.7/micronaut-http-server-netty-4.10.7.jar:/home/g/.m2/repository/org/slf4j/slf4j-api/2.0.17/slf4j-api-2.0.17.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-server/4.10.7/micronaut-http-server-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-http/4.10.7/micronaut-http-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-core-reactive/4.10.7/micronaut-core-reactive-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-context-propagation/4.10.7/micronaut-context-propagation-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-router/4.10.7/micronaut-router-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-core/4.10.7/micronaut-core-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-netty/4.10.7/micronaut-http-netty-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-buffer-netty/4.10.7/micronaut-buffer-netty-4.10.7.jar:/home/g/.m2/repository/io/netty/netty-codec-http2/4.2.7.Final/netty-codec-http2-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-handler/4.2.7.Final/netty-handler-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-resolver/4.2.7.Final/netty-resolver-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-transport-native-unix-common/4.2.7.Final/netty-transport-native-unix-common-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-http/4.2.7.Final/netty-codec-http-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-common/4.2.7.Final/netty-common-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-buffer/4.2.7.Final/netty-buffer-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-transport/4.2.7.Final/netty-transport-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-base/4.2.7.Final/netty-codec-base-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-compression/4.2.7.Final/netty-codec-compression-4.2.7.Final.jar:/home/g/.m2/repository/io/projectreactor/reactor-core/3.7.12/reactor-core-3.7.12.jar:/home/g/.m2/repository/org/reactivestreams/reactive-streams/1.0.4/reactive-streams-1.0.4.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-jackson/2.16.1/micronaut-serde-jackson-2.16.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-inject/4.10.7/micronaut-inject-4.10.7.jar:/home/g/.m2/repository/jakarta/inject/jakarta.inject-api/2.0.1/jakarta.inject-api-2.0.1.jar:/home/g/.m2/repository/jakarta/annotation/jakarta.annotation-api/2.1.1/jakarta.annotation-api-2.1.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-jackson-core/4.10.7/micronaut-jackson-core-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-json-core/4.10.7/micronaut-json-core-4.10.7.jar:/home/g/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.19.2/jackson-core-2.19.2.jar:/home/g/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.19.2/jackson-annotations-2.19.2.jar:/home/g/.m2/repository/io/micronaut/micronaut-context/4.10.7/micronaut-context-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-aop/4.10.7/micronaut-aop-4.10.7.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-api/2.16.1/micronaut-serde-api-2.16.1.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-support/2.16.1/micronaut-serde-support-2.16.1.jar:/home/g/.m2/repository/ch/qos/logback/logback-classic/1.5.19/logback-classic-1.5.19.jar:/home/g/.m2/repository/ch/qos/logback/logback-core/1.5.19/logback-core-1.5.19.jar \
#   --no-fallback \
#   -o /home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/libmicronautbaselayer \
#   -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-handler/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/ch.qos.logback/logback-classic/1.4.9,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-common/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-codec-http/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-buffer/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-codec-http2/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-transport/4.1.80.Final \
#   --no-fallback \
#   -H:+UnlockExperimentalVMOptions \
#   -H:LayerCreate=base-layer.nil,module=java.base,package=io.micronaut.*,package=io.netty.*,package=jakarta.*,package=com.fasterxml.jackson.*,package=org.slf4j.*,package=reactor.*,package=org.reactivestreams.* \
#   -H:ApplicationLayerOnlySingletons=io.micronaut.core.io.service.ServiceScanner$StaticServiceDefinitions \
#   -H:ApplicationLayerInitializedClasses=io.micronaut.inject.annotation.AnnotationMetadataSupport \
#   -H:ApplicationLayerInitializedClasses=io.micronaut.core.io.service.MicronautMetaServiceLoaderUtils \
#   -H:-UnlockExperimentalVMOptions \
#   -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/native/generated/generateResourceConfig,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/native/generated/generateTestResourceConfig \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-codec-http2/4.2.7.Final/netty-codec-http2-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-handler/4.2.7.Final/netty-handler-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-codec-http/4.2.7.Final/netty-codec-http-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-common/4.2.7.Final/netty-common-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-buffer/4.2.7.Final/netty-buffer-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   --exclude-config \Q/home/g/.m2/repository/io/netty/netty-transport/4.2.7.Final/netty-transport-4.2.7.Final.jar\E ^/META-INF/native-image/ \
#   -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/native/generated/generateResourceConfig,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/base-layer-target/native/generated/generateTestResourceConfig

# Micronaut app layer:
# /home/g/src/mandrel/sdk/latest_graalvm_home/bin/native-image -cp /home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/micronaut-hello-rest-maven-layered-0.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-server-netty/4.10.7/micronaut-http-server-netty-4.10.7.jar:/home/g/.m2/repository/org/slf4j/slf4j-api/2.0.17/slf4j-api-2.0.17.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-server/4.10.7/micronaut-http-server-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-http/4.10.7/micronaut-http-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-core-reactive/4.10.7/micronaut-core-reactive-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-context-propagation/4.10.7/micronaut-context-propagation-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-router/4.10.7/micronaut-router-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-core/4.10.7/micronaut-core-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-http-netty/4.10.7/micronaut-http-netty-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-buffer-netty/4.10.7/micronaut-buffer-netty-4.10.7.jar:/home/g/.m2/repository/io/netty/netty-codec-http2/4.2.7.Final/netty-codec-http2-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-handler/4.2.7.Final/netty-handler-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-resolver/4.2.7.Final/netty-resolver-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-transport-native-unix-common/4.2.7.Final/netty-transport-native-unix-common-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-http/4.2.7.Final/netty-codec-http-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-common/4.2.7.Final/netty-common-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-buffer/4.2.7.Final/netty-buffer-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-transport/4.2.7.Final/netty-transport-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-base/4.2.7.Final/netty-codec-base-4.2.7.Final.jar:/home/g/.m2/repository/io/netty/netty-codec-compression/4.2.7.Final/netty-codec-compression-4.2.7.Final.jar:/home/g/.m2/repository/io/projectreactor/reactor-core/3.7.12/reactor-core-3.7.12.jar:/home/g/.m2/repository/org/reactivestreams/reactive-streams/1.0.4/reactive-streams-1.0.4.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-jackson/2.16.1/micronaut-serde-jackson-2.16.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-inject/4.10.7/micronaut-inject-4.10.7.jar:/home/g/.m2/repository/jakarta/inject/jakarta.inject-api/2.0.1/jakarta.inject-api-2.0.1.jar:/home/g/.m2/repository/jakarta/annotation/jakarta.annotation-api/2.1.1/jakarta.annotation-api-2.1.1.jar:/home/g/.m2/repository/io/micronaut/micronaut-jackson-core/4.10.7/micronaut-jackson-core-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-json-core/4.10.7/micronaut-json-core-4.10.7.jar:/home/g/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.19.2/jackson-core-2.19.2.jar:/home/g/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.19.2/jackson-annotations-2.19.2.jar:/home/g/.m2/repository/io/micronaut/micronaut-context/4.10.7/micronaut-context-4.10.7.jar:/home/g/.m2/repository/io/micronaut/micronaut-aop/4.10.7/micronaut-aop-4.10.7.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-api/2.16.1/micronaut-serde-api-2.16.1.jar:/home/g/.m2/repository/io/micronaut/serde/micronaut-serde-support/2.16.1/micronaut-serde-support-2.16.1.jar:/home/g/.m2/repository/ch/qos/logback/logback-classic/1.5.19/logback-classic-1.5.19.jar:/home/g/.m2/repository/ch/qos/logback/logback-core/1.5.19/logback-core-1.5.19.jar --no-fallback -o /home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/layered-app -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/ch.qos.logback/logback-classic/1.4.9,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-codec-http2/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-buffer/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-codec-http/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-handler/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-common/4.1.80.Final,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/graalvm-reachability-metadata/b054434589ed97bfd2d613941749d0234384315/io.netty/netty-transport/4.1.80.Final --no-fallback -H:+UnlockExperimentalVMOptions -H:LayerUse=base-layer-target/base-layer.nil -H:LinkerRPath=$ORIGIN -H:-UnlockExperimentalVMOptions -H:-LayerOptionVerification -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/native/generated/generateResourceConfig,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/native/generated/generateTestResourceConfig --exclude-config \Q/home/g/.m2/repository/io/netty/netty-codec-http2/4.2.7.Final/netty-codec-http2-4.2.7.Final.jar\E ^/META-INF/native-image/ --exclude-config \Q/home/g/.m2/repository/io/netty/netty-handler/4.2.7.Final/netty-handler-4.2.7.Final.jar\E ^/META-INF/native-image/ --exclude-config \Q/home/g/.m2/repository/io/netty/netty-codec-http/4.2.7.Final/netty-codec-http-4.2.7.Final.jar\E ^/META-INF/native-image/ --exclude-config \Q/home/g/.m2/repository/io/netty/netty-common/4.2.7.Final/netty-common-4.2.7.Final.jar\E ^/META-INF/native-image/ --exclude-config \Q/home/g/.m2/repository/io/netty/netty-buffer/4.2.7.Final/netty-buffer-4.2.7.Final.jar\E ^/META-INF/native-image/ --exclude-config \Q/home/g/.m2/repository/io/netty/netty-transport/4.2.7.Final/netty-transport-4.2.7.Final.jar\E ^/META-INF/native-image/ -H:ConfigurationFileDirectories=/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/native/generated/generateResourceConfig,/home/g/src/mendrugo/micronaut-hello-rest-maven-layered/app-layer-target/native/generated/generateTestResourceConfig example.micronaut.Application

